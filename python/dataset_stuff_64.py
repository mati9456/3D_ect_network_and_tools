# imports
import scipy
import os
import time
import csv
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

import torch
import torch.nn as nn           
import torch.nn.functional as F 
import torch.optim as optim
from torch.utils.data import Dataset, DataLoader
from torch.utils.data import ConcatDataset
import torchvision.transforms as transforms

from augment_mappings import flip_map, rot90_map, full_meas, empty_meas

meas_diff = full_meas-empty_meas

class ECTsimDataset(Dataset):

    def __init__(self, csv_file, transform=None, target_transform=None, SNR=None, augment=True, mode32=False):
        self.ect_frame = pd.read_csv(csv_file)
        self.transform = transform
        self.target_transform = target_transform
        self.SNR = SNR
        self.augment = augment
        self.mode32 = mode32

    def __len__(self):
        return len(self.ect_frame)

    def __getitem__(self, idx):
        c_name = os.path.join(self.ect_frame.iloc[idx, 0])
        ect_name = os.path.join(self.ect_frame.iloc[idx, 1])
        c = np.load(c_name)
        eps_map = np.load(ect_name)

        if self.mode32:
            eps_map = eps_map[::2, ::2, ::2]

        if self.augment:
            rot = np.random.randint(0, 4)
            flip = np.random.randint(0, 2)

            for i in range(0, rot):
                new_c = np.empty_like(c)
                for original_index, new_index in rot90_map.items():
                    new_c[new_index] = c[original_index]
                c = new_c
                eps_map = np.rot90(eps_map)
            
            if flip == 1:
                new_c = np.empty_like(c)
                for original_index, new_index in flip_map.items():
                    new_c[new_index] = c[original_index]
                c = new_c
                eps_map = np.flip(eps_map, axis=2)

            eps_map = eps_map.copy() # pytorch does not support negative strides

        if self.SNR is not None:
            c = add_noise(c, SNRdb=self.SNR)

        if self.transform is not None:
            c = self.transform(c)

        if self.target_transform is not None:
            eps_map = self.target_transform(eps_map)

        return c, eps_map
    

class ToFloat16(object):
    def __call__(self, sample):
        return sample.to(torch.float16)
    
class ToFloat32(object):
    def __call__(self, sample):
        return sample.to(torch.float32)
    
class Perm3d(object):
    def __call__(self, sample):
        return torch.permute(sample, (2, 1, 0))
    
class UnNormalize(object):
    def __init__(self, mean, std):
        self.mean = mean
        self.std = std
    def __call__(self, tensor):
        return tensor.mul_(self.std).add_(self.mean)
    
class NormalizeTransform(object):
    def __init__(self, mean, stdev):
        self.mean = mean
        self.stdev = stdev
    def __call__(self, tensor):
        return (tensor - self.mean) / self.stdev


class Pad496To512(object):
    def __call__(self, tensor):
        return torch.nn.functional.pad(tensor, (8, 8), mode='constant', value=0)
    
class Pad606050To646464(object):
    def __call__(self, tensor):
        return torch.nn.functional.pad(tensor, (7, 7, 2, 2, 2, 2), mode='constant', value=1)
    
class Pad6060To6464(object):
    def __call__(self, tensor):
        return torch.nn.functional.pad(tensor, (2, 2, 2, 2), mode='constant', value=1)

class ToTensor():
    def __call__(self, array):
        return torch.tensor(array)
    
reconstr_mean = 2#1.14204013 #1
reconstr_stdev = 1# 0.51371669 #2


def create_ect_dataloaders(csv_file, batch_size=32, SNR=None, optim=True, augment=True, mode32=False):
    transform_in = transforms.Compose([ ToTensor(),
                                        ToFloat32(),
                                        #Pad496To512(),
                                        #NormalizeTransform(0.10184967, 0.14424020),
                                        ])

    transform_out = transforms.Compose([ToTensor(),
                                        ToFloat32(),
                                        #Pad606050To646464(),
                                        NormalizeTransform(reconstr_mean, reconstr_stdev),
                                        #Perm3d(),
                                        ])

    ect_dataset = ECTsimDataset(csv_file=csv_file, transform=transform_in, target_transform=transform_out, SNR=SNR, augment=augment, mode32=mode32)
    
    if optim:
        train_dataloader = DataLoader(ect_dataset, batch_size=batch_size, shuffle=True, pin_memory=True, num_workers=16, persistent_workers=True)
    else:
        train_dataloader = DataLoader(ect_dataset, batch_size=batch_size, shuffle=True)
    return train_dataloader, ect_dataset
    

def unNormalizeTarget(y):
    unNormalize = UnNormalize(reconstr_mean, reconstr_stdev)
    return unNormalize(y)

def add_noise(c, SNRdb):
    SNR = 10**(SNRdb / 20)
    SNR = 5.81423964e-16 / SNR
    noise = np.random.randn(*c.shape) * SNR
    noise = noise/meas_diff
    c = c + noise
    return c


def reconstruct992(processed_unique_arr):
    positions = {(6.841739691181345e-14,): [0, 61],
 (8.274995035874804e-15,): [1, 91],
 (2.151489448315268e-15,): [2, 121],
 (9.172806242292875e-16,): [3, 151],
 (8.265137827681337e-16,): [4, 181],
 (6.074095835226101e-16,): [5, 211],
 (4.294196900305051e-16,): [6, 241],
 (3.509645996038317e-16,): [7],
 (4.980390604549668e-16,): [8, 301],
 (5.262328573459153e-16,): [9, 331],
 (5.874924579472669e-16,): [10, 361],
 (8.50837870980184e-16,): [11, 391],
 (2.513677973876314e-15,): [12, 421],
 (6.13870625470259e-15,): [13, 451],
 (4.497564704140564e-14,): [14, 481],
 (5.626110453816018e-15,): [15, 511],
 (4.289049388435674e-15,): [16],
 (2.1575385501397075e-15,): [17, 571],
 (9.725948720091735e-16,): [18, 601],
 (5.660131857671368e-16,): [19, 631],
 (6.823086946836971e-16,): [20, 661],
 (4.981042870053122e-16,): [21, 691],
 (3.618786761661561e-16,): [22, 721],
 (3.0099997863552086e-16,): [23, 751],
 (4.15161768166758e-16,): [24, 781],
 (4.1783071978528567e-16,): [25, 811],
 (4.211836131930429e-16,): [26, 841],
 (4.97720053583658e-16,): [27, 871],
 (1.0483478463173148e-15,): [28, 901],
 (1.5877633996331374e-15,): [29, 931],
 (2.938964407068503e-15,): [30, 961],
 (1.3175531493623e-13,): [31, 92],
 (9.118153797126425e-15,): [32, 122],
 (2.571513709258796e-15,): [33, 152],
 (1.8385709563670502e-15,): [34, 182],
 (1.1712962565174923e-15,): [35, 212],
 (7.216833038877655e-16,): [36, 242],
 (5.267623563493559e-16,): [37, 272],
 (6.817787670203774e-16,): [38, 302],
 (6.658316173491333e-16,): [39, 332],
 (6.652199900782863e-16,): [40, 362],
 (8.097613707952628e-16,): [41, 392],
 (1.8397125855931114e-15,): [42, 422],
 (3.114876440001231e-15,): [43],
 (7.53232696212484e-15,): [44, 482],
 (4.472448551509057e-15,): [45, 512],
 (1.0082297163396363e-14,): [46, 542],
 (5.9166619363718455e-15,): [47, 572],
 (2.229457608329738e-15,): [48, 602],
 (1.1225922903614659e-15,): [49, 632],
 (1.2456104006239013e-15,): [50, 662],
 (8.546760214273387e-16,): [51, 692],
 (5.752990036666843e-16,): [52, 722],
 (4.521153554462354e-16,): [53, 752],
 (5.956765419410892e-16,): [54, 782],
 (5.763635346393431e-16,): [55, 812],
 (5.499814865864914e-16,): [56],
 (6.015985417001219e-16,): [57, 872],
 (1.1449130609377927e-15,): [58],
 (1.5328003247284377e-15,): [59, 932],
 (2.2696446911546154e-15,): [60, 962],
 (4.769514671018684e-14,): [62, 123],
 (6.128556937538344e-15,): [63, 153],
 (3.060074337858909e-15,): [64, 183],
 (1.588043341823799e-15,): [65, 213],
 (8.170841133439811e-16,): [66, 243],
 (5.244865881412512e-16,): [67, 273],
 (6.222899626350004e-16,): [68],
 (5.68773482458937e-16,): [69, 333],
 (5.274893438604825e-16,): [70, 363],
 (5.777251569192344e-16,): [71, 393],
 (1.1361676554581695e-15,): [72, 423],
 (1.6102695033866853e-15,): [73, 453],
 (2.7724536472478063e-15,): [74, 483],
 (2.2774910579288895e-15,): [75, 513],
 (5.9048885374487906e-15,): [76, 543],
 (9.222786736355317e-15,): [77, 573],
 (3.88080123754066e-15,): [78, 603],
 (1.5621250636597353e-15,): [79, 633],
 (1.5158801343462269e-15,): [80, 663],
 (9.41409601105407e-16,): [81, 693],
 (5.658853028228568e-16,): [82, 723],
 (4.1299424737562696e-16,): [83, 753],
 (5.179647120544286e-16,): [84, 783],
 (4.814483443798143e-16,): [85],
 (4.4038567429898475e-16,): [86, 843],
 (4.547800186160172e-16,): [87, 873],
 (8.088702341931386e-16,): [88, 903],
 (1.0108635442669492e-15,): [89, 933],
 (1.3621062609621816e-15,): [90, 963],
 (4.5052370160925186e-14,): [93, 154],
 (7.57880552849581e-15,): [94, 184],
 (2.7888499151890414e-15,): [95, 214],
 (1.08833160372829e-15,): [96],
 (5.772939627254055e-16,): [97, 274],
 (6.031427331914564e-16,): [98, 304],
 (5.030542230294829e-16,): [99, 334],
 (4.16820797519852e-16,): [100, 364],
 (3.9934911629276497e-16,): [101, 394],
 (6.770502178283984e-16,): [102, 424],
 (8.257760968745397e-16,): [103, 454],
 (1.117036494829814e-15,): [104, 484],
 (1.037562877940583e-15,): [105, 514],
 (2.229834131413196e-15,): [106, 544],
 (3.884867284223934e-15,): [107, 574],
 (8.151890809208644e-15,): [108, 604],
 (2.918607407192685e-15,): [109, 634],
 (2.2448228786660957e-15,): [110, 664],
 (1.2290829774936872e-15,): [111, 694],
 (6.130594954369516e-16,): [112, 724],
 (3.936208655680016e-16,): [113, 754],
 (4.549302161136576e-16,): [114, 784],
 (3.989273606048092e-16,): [115, 814],
 (3.386483098235571e-16,): [116, 844],
 (3.2062879966394147e-16,): [117, 874],
 (5.215592928967955e-16,): [118, 904],
 (6.00887941947012e-16,): [119, 934],
 (7.214947798578063e-16,): [120, 964],
 (6.850013874268311e-14,): [124, 185],
 (8.372292168528313e-15,): [125, 215],
 (2.0482303584210362e-15,): [126, 245],
 (8.391050608676326e-16,): [127, 275],
 (7.377264100258455e-16,): [128, 305],
 (5.428312289525487e-16,): [129, 335],
 (3.920355001659886e-16,): [130, 365],
 (3.259165157933433e-16,): [131, 395],
 (4.839324823531645e-16,): [132, 425],
 (5.262099638432014e-16,): [133, 455],
 (6.061177886589069e-16,): [134, 485],
 (5.916132915952254e-16,): [135, 515],
 (1.100463015980826e-15,): [136, 545],
 (1.5388557814639194e-15,): [137, 575],
 (2.885408425628244e-15,): [138, 605],
 (5.6531626257576986e-15,): [139, 635],
 (4.488403285847575e-15,): [140, 665],
 (2.0732413808642254e-15,): [141, 695],
 (8.476259233028973e-16,): [142, 725],
 (4.649059215427249e-16,): [143, 755],
 (4.827059727171375e-16,): [144, 785],
 (3.9126245487624614e-16,): [145, 815],
 (3.040542293401998e-16,): [146, 845],
 (2.6245730672024716e-16,): [147, 875],
 (3.9219324879250686e-16,): [148, 905],
 (4.210648232499249e-16,): [149, 935],
 (4.61119916391856e-16,): [150, 965],
 (1.2709654427579547e-13,): [155, 216],
 (9.31151310150449e-15,): [156, 246],
 (2.500411369138226e-15,): [157, 276],
 (1.7036964899355048e-15,): [158, 306],
 (1.0544646056871134e-15,): [159, 336],
 (6.450552146964677e-16,): [160, 366],
 (4.646557548441496e-16,): [161, 396],
 (6.160192695281841e-16,): [162, 426],
 (6.137141921275245e-16,): [163, 456],
 (6.348607801254051e-16,): [164, 486],
 (6.289169754318767e-16,): [165],
 (1.0663285570451818e-15,): [166, 546],
 (1.2932793315434623e-15,): [167, 576],
 (1.9486501581779595e-15,): [168, 606],
 (4.2970144175494896e-15,): [169, 636],
 (1.0794072249661586e-14,): [170, 666],
 (6.025985930822206e-15,): [171, 696],
 (2.0871032487752072e-15,): [172, 726],
 (9.661572785213617e-16,): [173, 756],
 (8.831790651711338e-16,): [174, 786],
 (6.506831082800539e-16,): [175, 816],
 (4.591988171722046e-16,): [176, 846],
 (3.6307032211183886e-16,): [177, 876],
 (5.052961440980367e-16,): [178, 906],
 (5.135893513245053e-16,): [179, 936],
 (5.284291821310432e-16,): [180, 966],
 (4.9387908635969554e-14,): [186, 247],
 (6.196494701198458e-15,): [187, 277],
 (2.9930391513913976e-15,): [188, 307],
 (1.5148173170450522e-15,): [189, 337],
 (7.77732426438391e-16,): [190, 367],
 (4.894138737805533e-16,): [191, 397],
 (5.879703800301309e-16,): [192, 427],
 (5.444847287995039e-16,): [193, 457],
 (5.187810803063761e-16,): [194, 487],
 (5.015577290486249e-16,): [195, 517],
 (7.95192477945086e-16,): [196, 547],
 (8.684414820020127e-16,): [197, 577],
 (1.1347922055167428e-15,): [198, 607],
 (2.142055535628611e-15,): [199, 637],
 (6.315260145315349e-15,): [200, 667],
 (9.718937278084312e-15,): [201, 697],
 (3.9172922617553376e-15,): [202, 727],
 (1.4813601691729034e-15,): [203, 757],
 (1.1682201609482517e-15,): [204, 787],
 (7.726694059578698e-16,): [205, 817],
 (4.92279045708111e-16,): [206, 847],
 (3.5787473478987814e-16,): [207, 877],
 (4.677936370098925e-16,): [208, 907],
 (4.537631962748387e-16,): [209, 937],
 (4.452017525873694e-16,): [210, 967],
 (4.525198632006294e-14,): [217, 278],
 (7.558363596947701e-15,): [218, 308],
 (2.7035548242189514e-15,): [219, 338],
 (1.0623304059117335e-15,): [220, 368],
 (5.530795424432568e-16,): [221, 398],
 (5.823927616185093e-16,): [222, 428],
 (4.903682221376392e-16,): [223, 458],
 (4.157920513609084e-16,): [224, 488],
 (3.734168035688255e-16,): [225, 518],
 (5.515714660127972e-16,): [226],
 (5.425343763427662e-16,): [227, 578],
 (5.943491709883653e-16,): [228, 608],
 (9.258658354313747e-16,): [229, 638],
 (2.2770503164988698e-15,): [230, 668],
 (3.92722236113556e-15,): [231, 698],
 (8.211118247482861e-15,): [232, 728],
 (2.862901844149054e-15,): [233, 758],
 (1.7975305016838794e-15,): [234, 788],
 (1.018213533348509e-15,): [235, 818],
 (5.543609910763407e-16,): [236, 848],
 (3.5557578721279085e-16,): [237, 878],
 (4.2584614227989347e-16,): [238, 908],
 (3.8849527217657345e-16,): [239, 938],
 (3.545818523906251e-16,): [240, 968],
 (1.0883316037282901e-15,): [244],
 (6.934742990358716e-14,): [248, 309],
 (8.413044448400564e-15,): [249, 339],
 (2.1073597084011648e-15,): [250, 369],
 (8.380070057692177e-16,): [251, 399],
 (7.312351504049774e-16,): [252, 429],
 (5.367450696328408e-16,): [253, 459],
 (3.908378136802497e-16,): [254, 489],
 (3.077092159274403e-16,): [255, 519],
 (4.2936253376385163e-16,): [256, 549],
 (3.914582644133804e-16,): [257, 579],
 (3.7533776414012284e-16,): [258],
 (4.947444495222655e-16,): [259, 639],
 (1.0581052539406527e-15,): [260, 669],
 (1.4832415448350507e-15,): [261, 699],
 (2.858208728076876e-15,): [262, 729],
 (5.57305099696337e-15,): [263, 759],
 (3.871237340850385e-15,): [264, 789],
 (1.7747794875269855e-15,): [265, 819],
 (7.917849149571742e-16,): [266, 849],
 (4.2993344690146967e-16,): [267, 879],
 (4.544573198302696e-16,): [268, 909],
 (3.787296721929654e-16,): [269, 939],
 (3.144905320816362e-16,): [270, 969],
 (3.5096459960383164e-16,): [271],
 (1.3328057674008536e-13,): [279, 340],
 (9.320175087091306e-15,): [280, 370],
 (2.4934417150843657e-15,): [281, 400],
 (1.6977955382440042e-15,): [282, 430],
 (1.050262292210628e-15,): [283, 460],
 (6.408333122368439e-16,): [284, 490],
 (4.2452136697663067e-16,): [285, 520],
 (5.665859576204895e-16,): [286, 550],
 (4.904975039880958e-16,): [287, 580],
 (4.3066856803599575e-16,): [288],
 (5.034649377696984e-16,): [289],
 (9.709116105550681e-16,): [290, 670],
 (1.169382736746631e-15,): [291, 700],
 (1.7905268981850737e-15,): [292, 730],
 (3.868170213815351e-15,): [293, 760],
 (9.644216725755353e-15,): [294, 790],
 (5.6195148966145675e-15,): [295, 820],
 (2.046265255706051e-15,): [296, 850],
 (9.268605154834092e-16,): [297, 880],
 (8.466794398948282e-16,): [298, 910],
 (6.315973340566215e-16,): [299, 940],
 (4.685923938720573e-16,): [300, 970],
 (6.222899626350003e-16,): [303],
 (4.819014599382494e-14,): [310, 371],
 (6.155279916115692e-15,): [311, 401],
 (2.997391059071619e-15,): [312, 431],
 (1.524055728459126e-15,): [313, 461],
 (7.765047982096609e-16,): [314, 491],
 (4.2713386395199434e-16,): [315, 521],
 (5.493447358487832e-16,): [316, 551],
 (4.563643373717761e-16,): [317, 581],
 (3.762060040584335e-16,): [318, 611],
 (4.02327147239934e-16,): [319, 641],
 (7.185758057691845e-16,): [320],
 (7.744830927494039e-16,): [321, 701],
 (1.0131667874048857e-15,): [322, 731],
 (1.7719181222320854e-15,): [323, 761],
 (5.617992462943648e-15,): [324, 791],
 (9.316158970227254e-15,): [325, 821],
 (3.924698241996018e-15,): [326, 851],
 (1.4729284345071303e-15,): [327, 881],
 (1.1571050782683786e-15,): [328, 911],
 (7.691233547544974e-16,): [329, 941],
 (5.0859492633809e-16,): [330, 971],
 (4.527065080221976e-14,): [341, 402],
 (7.570474179307927e-15,): [342, 432],
 (2.7327299710121785e-15,): [343, 462],
 (1.0552962100493976e-15,): [344, 492],
 (4.2869955067925596e-16,): [345, 522],
 (5.24430855187287e-16,): [346, 552],
 (4.1746369340014503e-16,): [347, 582],
 (3.184556547385437e-16,): [348, 612],
 (3.0774371855963215e-16,): [349, 642],
 (5.066451113384402e-16,): [350, 672],
 (4.942123665330228e-16,): [351, 702],
 (5.512493070390561e-16,): [352, 732],
 (7.902269129021185e-16,): [353, 762],
 (2.045224907915777e-15,): [354, 792],
 (3.9248858453003924e-15,): [355, 822],
 (8.247157729366605e-15,): [356, 852],
 (2.8757685604061806e-15,): [357, 882],
 (1.806310407273133e-15,): [358, 912],
 (1.0265113351659359e-15,): [359, 942],
 (5.721480571004293e-16,): [360, 972],
 (6.892817909601065e-14,): [372, 433],
 (8.476423217827647e-15,): [373, 463],
 (2.0414614065450886e-15,): [374, 493],
 (5.027805253710532e-16,): [375, 523],
 (5.725438330462062e-16,): [376, 553],
 (4.3031812862044247e-16,): [377, 583],
 (3.0040924102880313e-16,): [378, 613],
 (2.6141630955587283e-16,): [379, 643],
 (3.993274331792926e-16,): [380, 673],
 (3.5917162128960903e-16,): [381, 703],
 (3.5297020068937826e-16,): [382, 733],
 (4.289534055217842e-16,): [383, 763],
 (9.260359361708026e-16,): [384, 793],
 (1.4732244047626604e-15,): [385, 823],
 (2.8764856485667047e-15,): [386, 853],
 (5.587657436288516e-15,): [387, 883],
 (3.880694513309949e-15,): [388, 913],
 (1.7716972556618003e-15,): [389, 943],
 (7.914961481492689e-16,): [390, 973],
 (1.2747803689108633e-13,): [403, 464],
 (9.350613441041135e-15,): [404, 494],
 (1.0498479131593336e-15,): [405, 524],
 (1.085263617364452e-15,): [406, 554],
 (7.622337027023272e-16,): [407, 584],
 (4.861776184257083e-16,): [408, 614],
 (3.847247232024306e-16,): [409, 644],
 (5.531128944223798e-16,): [410, 674],
 (4.679486820496292e-16,): [411, 704],
 (4.2098578975026836e-16,): [412, 734],
 (4.526875934868324e-16,): [413, 764],
 (8.449221019936483e-16,): [414, 794],
 (1.156917215586524e-15,): [415, 824],
 (1.807616088147509e-15,): [416, 854],
 (3.881900990037211e-15,): [417, 884],
 (1.0083972116251012e-14,): [418, 914],
 (5.788545177994478e-15,): [419, 944],
 (2.0412194597960773e-15,): [420, 974],
 (4.9366156387894696e-14,): [434, 495],
 (1.5794161169259854e-15,): [435, 525],
 (1.446719588533582e-15,): [436, 555],
 (9.476014391669885e-16,): [437],
 (5.566339093813642e-16,): [438, 615],
 (4.071113154429206e-16,): [439, 645],
 (5.585375134081277e-16,): [440, 675],
 (4.509817324320954e-16,): [441, 705],
 (3.8123576951749296e-16,): [442, 735],
 (3.7552028986432385e-16,): [443, 765],
 (6.282458293876473e-16,): [444, 795],
 (7.675050608889504e-16,): [445, 825],
 (1.0273521752871395e-15,): [446, 855],
 (1.7739608948542936e-15,): [447, 885],
 (5.791579945102091e-15,): [448, 915],
 (9.710897152201057e-15,): [449, 945],
 (3.9024780841632645e-15,): [450, 975],
 (3.1148764400012303e-15,): [452],
 (2.913995501162745e-15,): [465, 526],
 (2.1338355517366094e-15,): [466, 556],
 (1.2671998092139719e-15,): [467, 586],
 (6.630468079628635e-16,): [468, 616],
 (4.3738626735355845e-16,): [469, 646],
 (5.656433960503256e-16,): [470, 676],
 (4.365418524440951e-16,): [471, 706],
 (3.421008032611309e-16,): [472, 736],
 (3.072532716418467e-16,): [473, 766],
 (4.598650982282749e-16,): [474, 796],
 (5.016182449398642e-16,): [475, 826],
 (5.687445474575957e-16,): [476, 856],
 (7.920993100678805e-16,): [477, 886],
 (2.0478660441924248e-15,): [478, 916],
 (3.912404367921464e-15,): [479, 946],
 (8.162851031429195e-15,): [480, 976],
 (6.808642976605693e-14,): [496, 557],
 (8.229024210074586e-15,): [497, 587],
 (2.1899214283241427e-15,): [498, 617],
 (9.822795511419033e-16,): [499, 647],
 (1.0487273595734778e-15,): [500],
 (7.431253126418114e-16,): [501, 707],
 (5.311597658440943e-16,): [502, 737],
 (4.4159774686408624e-16,): [503, 767],
 (6.162721563868107e-16,): [504, 797],
 (6.340366686472319e-16,): [505, 827],
 (6.760963846347206e-16,): [506, 857],
 (9.18251197172344e-16,): [507, 887],
 (2.5624085006512023e-15,): [508, 917],
 (6.090659309422098e-15,): [509, 947],
 (4.4672547543823766e-14,): [510, 977],
 (6.289169754318765e-16,): [516],
 (1.3180163737874932e-13,): [527, 588],
 (9.044277300826635e-15,): [528, 618],
 (2.538530855592129e-15,): [529, 648],
 (2.1046757592720704e-15,): [530, 678],
 (1.3039316030987373e-15,): [531, 708],
 (8.130904674104665e-16,): [532, 738],
 (6.176161351765009e-16,): [533, 768],
 (8.070958325088166e-16,): [534, 798],
 (7.849294620542455e-16,): [535, 828],
 (7.701507284693322e-16,): [536, 858],
 (9.045249168843807e-16,): [537, 888],
 (1.9676738781899626e-15,): [538],
 (3.2131254158693025e-15,): [539, 948],
 (7.522082212738101e-15,): [540, 978],
 (4.289049388435673e-15,): [541],
 (5.515714660127974e-16,): [548],
 (4.768779782331411e-14,): [558, 619],
 (6.002531535487838e-15,): [559, 649],
 (3.36994929856982e-15,): [560, 679],
 (1.7136489656856242e-15,): [561, 709],
 (8.735300571098202e-16,): [562],
 (5.8692524852212325e-16,): [563, 769],
 (7.131636879820554e-16,): [564, 799],
 (6.574117928924077e-16,): [565, 829],
 (6.082754862597981e-16,): [566],
 (6.5439567412322e-16,): [567, 889],
 (1.2522450694008515e-15,): [568, 919],
 (1.7273051068859717e-15,): [569, 949],
 (2.868294987860344e-15,): [570, 979],
 (9.476014391669887e-16,): [585],
 (4.480057513429942e-14,): [589, 650],
 (8.078559841126996e-15,): [590, 680],
 (3.0189082260438128e-15,): [591, 710],
 (1.1187239841460449e-15,): [592, 740],
 (6.103205353937467e-16,): [593, 770],
 (6.556321091377225e-16,): [594, 800],
 (5.564683190335995e-16,): [595, 830],
 (4.674579058077468e-16,): [596, 860],
 (4.484307624006696e-16,): [597, 890],
 (7.532718172351559e-16,): [598, 920],
 (9.068598691419567e-16,): [599, 950],
 (1.1986163755489068e-15,): [600],
 (3.753377641401229e-16,): [609],
 (4.3066856803599585e-16,): [610],
 (6.884498392696892e-14,): [620, 681],
 (9.461668976820907e-15,): [621, 711],
 (2.2612485241579475e-15,): [622, 741],
 (9.28091097097592e-16,): [623, 771],
 (8.306252815485272e-16,): [624, 801],
 (6.219768033933622e-16,): [625, 831],
 (4.575568561800081e-16,): [626, 861],
 (3.8395363563723005e-16,): [627, 891],
 (5.690183763037016e-16,): [628, 921],
 (6.139219901527024e-16,): [629, 951],
 (6.933044910706134e-16,): [630, 981],
 (5.034649377696982e-16,): [640],
 (1.2564385437216888e-13,): [651, 712],
 (9.459955332721018e-15,): [652, 742],
 (2.622148460924988e-15,): [653, 772],
 (1.8669351561244668e-15,): [654, 802],
 (1.2100280149451182e-15,): [655, 832],
 (7.809898136429708e-16,): [656, 862],
 (5.893561990371063e-16,): [657],
 (8.045068320401791e-16,): [658, 922],
 (8.144068933345848e-16,): [659],
 (8.445892198641028e-16,): [660, 982],
 (7.185758057691846e-16,): [671],
 (1.0487273595734782e-15,): [677],
 (4.910664240047019e-14,): [682, 743],
 (6.125636602272762e-15,): [683, 773],
 (2.982912957866799e-15,): [684, 803],
 (1.544765749968978e-15,): [685, 833],
 (8.316206513757888e-16,): [686, 863],
 (5.538839362372618e-16,): [687, 893],
 (6.957723625122194e-16,): [688, 923],
 (6.641818614256484e-16,): [689, 953],
 (6.491680397990966e-16,): [690, 983],
 (4.514477405302967e-14,): [713, 774],
 (7.486292168538665e-15,): [714, 804],
 (2.6787743463778753e-15,): [715, 834],
 (1.076636486004282e-15,): [716, 864],
 (5.889969852628584e-16,): [717, 894],
 (6.537374281460836e-16,): [718, 924],
 (5.752324678352901e-16,): [719],
 (5.12148782868159e-16,): [720, 984],
 (8.7353005710982e-16,): [739],
 (6.923848769762258e-14,): [744, 805],
 (8.342406409369911e-15,): [745, 835],
 (2.0821092513158255e-15,): [746, 865],
 (8.46143419781043e-16,): [747, 895],
 (7.71999221429648e-16,): [748, 925],
 (5.970194871996074e-16,): [749, 955],
 (4.693622041553687e-16,): [750, 985],
 (1.3315110264942234e-13,): [775, 836],
 (9.24081809423173e-15,): [776, 866],
 (2.4668964382045307e-15,): [777, 896],
 (1.7113380474709795e-15,): [778, 926],
 (1.1007810490132471e-15,): [779, 956],
 (7.302240792216235e-16,): [780, 986],
 (4.8090685851376e-14,): [806, 867],
 (6.101730178583315e-15,): [807, 897],
 (2.9737904637661735e-15,): [808, 927],
 (1.5422470361624926e-15,): [809, 957],
 (8.441508769099643e-16,): [810, 987],
 (4.814483443798141e-16,): [813],
 (4.519424832880532e-14,): [837, 898],
 (7.503007843887973e-15,): [838, 928],
 (2.7068089804691234e-15,): [839, 958],
 (1.0882205752682291e-15,): [840, 988],
 (5.499814865864916e-16,): [842],
 (6.08275486259798e-16,): [859],
 (6.881252053541531e-14,): [868, 929],
 (8.390987755483306e-15,): [869, 959],
 (2.022458537673152e-15,): [870, 989],
 (5.893561990371064e-16,): [892],
 (1.272570127370646e-13,): [899, 960],
 (9.20415690200729e-15,): [900, 990],
 (1.1449130609377929e-15,): [902],
 (1.9676738781899634e-15,): [918],
 (4.908103086398338e-14,): [930, 991],
 (8.144068933345852e-16,): [952],
 (5.752324678352903e-16,): [954],
 (1.1986163755489064e-15,): [980]}
    
    unique_arr = [[6.841739691181345e-14],
 [8.274995035874804e-15],
 [2.151489448315268e-15],
 [9.172806242292875e-16],
 [8.265137827681337e-16],
 [6.074095835226101e-16],
 [4.294196900305051e-16],
 [3.509645996038317e-16],
 [4.980390604549668e-16],
 [5.262328573459153e-16],
 [5.874924579472669e-16],
 [8.50837870980184e-16],
 [2.513677973876314e-15],
 [6.13870625470259e-15],
 [4.497564704140564e-14],
 [5.626110453816018e-15],
 [4.289049388435674e-15],
 [2.1575385501397075e-15],
 [9.725948720091735e-16],
 [5.660131857671368e-16],
 [6.823086946836971e-16],
 [4.981042870053122e-16],
 [3.618786761661561e-16],
 [3.0099997863552086e-16],
 [4.15161768166758e-16],
 [4.1783071978528567e-16],
 [4.211836131930429e-16],
 [4.97720053583658e-16],
 [1.0483478463173148e-15],
 [1.5877633996331374e-15],
 [2.938964407068503e-15],
 [1.3175531493623e-13],
 [9.118153797126425e-15],
 [2.571513709258796e-15],
 [1.8385709563670502e-15],
 [1.1712962565174923e-15],
 [7.216833038877655e-16],
 [5.267623563493559e-16],
 [6.817787670203774e-16],
 [6.658316173491333e-16],
 [6.652199900782863e-16],
 [8.097613707952628e-16],
 [1.8397125855931114e-15],
 [3.114876440001231e-15],
 [7.53232696212484e-15],
 [4.472448551509057e-15],
 [1.0082297163396363e-14],
 [5.9166619363718455e-15],
 [2.229457608329738e-15],
 [1.1225922903614659e-15],
 [1.2456104006239013e-15],
 [8.546760214273387e-16],
 [5.752990036666843e-16],
 [4.521153554462354e-16],
 [5.956765419410892e-16],
 [5.763635346393431e-16],
 [5.499814865864914e-16],
 [6.015985417001219e-16],
 [1.1449130609377927e-15],
 [1.5328003247284377e-15],
 [2.2696446911546154e-15],
 [4.769514671018684e-14],
 [6.128556937538344e-15],
 [3.060074337858909e-15],
 [1.588043341823799e-15],
 [8.170841133439811e-16],
 [5.244865881412512e-16],
 [6.222899626350004e-16],
 [5.68773482458937e-16],
 [5.274893438604825e-16],
 [5.777251569192344e-16],
 [1.1361676554581695e-15],
 [1.6102695033866853e-15],
 [2.7724536472478063e-15],
 [2.2774910579288895e-15],
 [5.9048885374487906e-15],
 [9.222786736355317e-15],
 [3.88080123754066e-15],
 [1.5621250636597353e-15],
 [1.5158801343462269e-15],
 [9.41409601105407e-16],
 [5.658853028228568e-16],
 [4.1299424737562696e-16],
 [5.179647120544286e-16],
 [4.814483443798143e-16],
 [4.4038567429898475e-16],
 [4.547800186160172e-16],
 [8.088702341931386e-16],
 [1.0108635442669492e-15],
 [1.3621062609621816e-15],
 [4.5052370160925186e-14],
 [7.57880552849581e-15],
 [2.7888499151890414e-15],
 [1.08833160372829e-15],
 [5.772939627254055e-16],
 [6.031427331914564e-16],
 [5.030542230294829e-16],
 [4.16820797519852e-16],
 [3.9934911629276497e-16],
 [6.770502178283984e-16],
 [8.257760968745397e-16],
 [1.117036494829814e-15],
 [1.037562877940583e-15],
 [2.229834131413196e-15],
 [3.884867284223934e-15],
 [8.151890809208644e-15],
 [2.918607407192685e-15],
 [2.2448228786660957e-15],
 [1.2290829774936872e-15],
 [6.130594954369516e-16],
 [3.936208655680016e-16],
 [4.549302161136576e-16],
 [3.989273606048092e-16],
 [3.386483098235571e-16],
 [3.2062879966394147e-16],
 [5.215592928967955e-16],
 [6.00887941947012e-16],
 [7.214947798578063e-16],
 [6.850013874268311e-14],
 [8.372292168528313e-15],
 [2.0482303584210362e-15],
 [8.391050608676326e-16],
 [7.377264100258455e-16],
 [5.428312289525487e-16],
 [3.920355001659886e-16],
 [3.259165157933433e-16],
 [4.839324823531645e-16],
 [5.262099638432014e-16],
 [6.061177886589069e-16],
 [5.916132915952254e-16],
 [1.100463015980826e-15],
 [1.5388557814639194e-15],
 [2.885408425628244e-15],
 [5.6531626257576986e-15],
 [4.488403285847575e-15],
 [2.0732413808642254e-15],
 [8.476259233028973e-16],
 [4.649059215427249e-16],
 [4.827059727171375e-16],
 [3.9126245487624614e-16],
 [3.040542293401998e-16],
 [2.6245730672024716e-16],
 [3.9219324879250686e-16],
 [4.210648232499249e-16],
 [4.61119916391856e-16],
 [1.2709654427579547e-13],
 [9.31151310150449e-15],
 [2.500411369138226e-15],
 [1.7036964899355048e-15],
 [1.0544646056871134e-15],
 [6.450552146964677e-16],
 [4.646557548441496e-16],
 [6.160192695281841e-16],
 [6.137141921275245e-16],
 [6.348607801254051e-16],
 [6.289169754318767e-16],
 [1.0663285570451818e-15],
 [1.2932793315434623e-15],
 [1.9486501581779595e-15],
 [4.2970144175494896e-15],
 [1.0794072249661586e-14],
 [6.025985930822206e-15],
 [2.0871032487752072e-15],
 [9.661572785213617e-16],
 [8.831790651711338e-16],
 [6.506831082800539e-16],
 [4.591988171722046e-16],
 [3.6307032211183886e-16],
 [5.052961440980367e-16],
 [5.135893513245053e-16],
 [5.284291821310432e-16],
 [4.9387908635969554e-14],
 [6.196494701198458e-15],
 [2.9930391513913976e-15],
 [1.5148173170450522e-15],
 [7.77732426438391e-16],
 [4.894138737805533e-16],
 [5.879703800301309e-16],
 [5.444847287995039e-16],
 [5.187810803063761e-16],
 [5.015577290486249e-16],
 [7.95192477945086e-16],
 [8.684414820020127e-16],
 [1.1347922055167428e-15],
 [2.142055535628611e-15],
 [6.315260145315349e-15],
 [9.718937278084312e-15],
 [3.9172922617553376e-15],
 [1.4813601691729034e-15],
 [1.1682201609482517e-15],
 [7.726694059578698e-16],
 [4.92279045708111e-16],
 [3.5787473478987814e-16],
 [4.677936370098925e-16],
 [4.537631962748387e-16],
 [4.452017525873694e-16],
 [4.525198632006294e-14],
 [7.558363596947701e-15],
 [2.7035548242189514e-15],
 [1.0623304059117335e-15],
 [5.530795424432568e-16],
 [5.823927616185093e-16],
 [4.903682221376392e-16],
 [4.157920513609084e-16],
 [3.734168035688255e-16],
 [5.515714660127972e-16],
 [5.425343763427662e-16],
 [5.943491709883653e-16],
 [9.258658354313747e-16],
 [2.2770503164988698e-15],
 [3.92722236113556e-15],
 [8.211118247482861e-15],
 [2.862901844149054e-15],
 [1.7975305016838794e-15],
 [1.018213533348509e-15],
 [5.543609910763407e-16],
 [3.5557578721279085e-16],
 [4.2584614227989347e-16],
 [3.8849527217657345e-16],
 [3.545818523906251e-16],
 [1.0883316037282901e-15],
 [6.934742990358716e-14],
 [8.413044448400564e-15],
 [2.1073597084011648e-15],
 [8.380070057692177e-16],
 [7.312351504049774e-16],
 [5.367450696328408e-16],
 [3.908378136802497e-16],
 [3.077092159274403e-16],
 [4.2936253376385163e-16],
 [3.914582644133804e-16],
 [3.7533776414012284e-16],
 [4.947444495222655e-16],
 [1.0581052539406527e-15],
 [1.4832415448350507e-15],
 [2.858208728076876e-15],
 [5.57305099696337e-15],
 [3.871237340850385e-15],
 [1.7747794875269855e-15],
 [7.917849149571742e-16],
 [4.2993344690146967e-16],
 [4.544573198302696e-16],
 [3.787296721929654e-16],
 [3.144905320816362e-16],
 [3.5096459960383164e-16],
 [1.3328057674008536e-13],
 [9.320175087091306e-15],
 [2.4934417150843657e-15],
 [1.6977955382440042e-15],
 [1.050262292210628e-15],
 [6.408333122368439e-16],
 [4.2452136697663067e-16],
 [5.665859576204895e-16],
 [4.904975039880958e-16],
 [4.3066856803599575e-16],
 [5.034649377696984e-16],
 [9.709116105550681e-16],
 [1.169382736746631e-15],
 [1.7905268981850737e-15],
 [3.868170213815351e-15],
 [9.644216725755353e-15],
 [5.6195148966145675e-15],
 [2.046265255706051e-15],
 [9.268605154834092e-16],
 [8.466794398948282e-16],
 [6.315973340566215e-16],
 [4.685923938720573e-16],
 [6.222899626350003e-16],
 [4.819014599382494e-14],
 [6.155279916115692e-15],
 [2.997391059071619e-15],
 [1.524055728459126e-15],
 [7.765047982096609e-16],
 [4.2713386395199434e-16],
 [5.493447358487832e-16],
 [4.563643373717761e-16],
 [3.762060040584335e-16],
 [4.02327147239934e-16],
 [7.185758057691845e-16],
 [7.744830927494039e-16],
 [1.0131667874048857e-15],
 [1.7719181222320854e-15],
 [5.617992462943648e-15],
 [9.316158970227254e-15],
 [3.924698241996018e-15],
 [1.4729284345071303e-15],
 [1.1571050782683786e-15],
 [7.691233547544974e-16],
 [5.0859492633809e-16],
 [4.527065080221976e-14],
 [7.570474179307927e-15],
 [2.7327299710121785e-15],
 [1.0552962100493976e-15],
 [4.2869955067925596e-16],
 [5.24430855187287e-16],
 [4.1746369340014503e-16],
 [3.184556547385437e-16],
 [3.0774371855963215e-16],
 [5.066451113384402e-16],
 [4.942123665330228e-16],
 [5.512493070390561e-16],
 [7.902269129021185e-16],
 [2.045224907915777e-15],
 [3.9248858453003924e-15],
 [8.247157729366605e-15],
 [2.8757685604061806e-15],
 [1.806310407273133e-15],
 [1.0265113351659359e-15],
 [5.721480571004293e-16],
 [6.892817909601065e-14],
 [8.476423217827647e-15],
 [2.0414614065450886e-15],
 [5.027805253710532e-16],
 [5.725438330462062e-16],
 [4.3031812862044247e-16],
 [3.0040924102880313e-16],
 [2.6141630955587283e-16],
 [3.993274331792926e-16],
 [3.5917162128960903e-16],
 [3.5297020068937826e-16],
 [4.289534055217842e-16],
 [9.260359361708026e-16],
 [1.4732244047626604e-15],
 [2.8764856485667047e-15],
 [5.587657436288516e-15],
 [3.880694513309949e-15],
 [1.7716972556618003e-15],
 [7.914961481492689e-16],
 [1.2747803689108633e-13],
 [9.350613441041135e-15],
 [1.0498479131593336e-15],
 [1.085263617364452e-15],
 [7.622337027023272e-16],
 [4.861776184257083e-16],
 [3.847247232024306e-16],
 [5.531128944223798e-16],
 [4.679486820496292e-16],
 [4.2098578975026836e-16],
 [4.526875934868324e-16],
 [8.449221019936483e-16],
 [1.156917215586524e-15],
 [1.807616088147509e-15],
 [3.881900990037211e-15],
 [1.0083972116251012e-14],
 [5.788545177994478e-15],
 [2.0412194597960773e-15],
 [4.9366156387894696e-14],
 [1.5794161169259854e-15],
 [1.446719588533582e-15],
 [9.476014391669885e-16],
 [5.566339093813642e-16],
 [4.071113154429206e-16],
 [5.585375134081277e-16],
 [4.509817324320954e-16],
 [3.8123576951749296e-16],
 [3.7552028986432385e-16],
 [6.282458293876473e-16],
 [7.675050608889504e-16],
 [1.0273521752871395e-15],
 [1.7739608948542936e-15],
 [5.791579945102091e-15],
 [9.710897152201057e-15],
 [3.9024780841632645e-15],
 [3.1148764400012303e-15],
 [2.913995501162745e-15],
 [2.1338355517366094e-15],
 [1.2671998092139719e-15],
 [6.630468079628635e-16],
 [4.3738626735355845e-16],
 [5.656433960503256e-16],
 [4.365418524440951e-16],
 [3.421008032611309e-16],
 [3.072532716418467e-16],
 [4.598650982282749e-16],
 [5.016182449398642e-16],
 [5.687445474575957e-16],
 [7.920993100678805e-16],
 [2.0478660441924248e-15],
 [3.912404367921464e-15],
 [8.162851031429195e-15],
 [6.808642976605693e-14],
 [8.229024210074586e-15],
 [2.1899214283241427e-15],
 [9.822795511419033e-16],
 [1.0487273595734778e-15],
 [7.431253126418114e-16],
 [5.311597658440943e-16],
 [4.4159774686408624e-16],
 [6.162721563868107e-16],
 [6.340366686472319e-16],
 [6.760963846347206e-16],
 [9.18251197172344e-16],
 [2.5624085006512023e-15],
 [6.090659309422098e-15],
 [4.4672547543823766e-14],
 [6.289169754318765e-16],
 [1.3180163737874932e-13],
 [9.044277300826635e-15],
 [2.538530855592129e-15],
 [2.1046757592720704e-15],
 [1.3039316030987373e-15],
 [8.130904674104665e-16],
 [6.176161351765009e-16],
 [8.070958325088166e-16],
 [7.849294620542455e-16],
 [7.701507284693322e-16],
 [9.045249168843807e-16],
 [1.9676738781899626e-15],
 [3.2131254158693025e-15],
 [7.522082212738101e-15],
 [4.289049388435673e-15],
 [5.515714660127974e-16],
 [4.768779782331411e-14],
 [6.002531535487838e-15],
 [3.36994929856982e-15],
 [1.7136489656856242e-15],
 [8.735300571098202e-16],
 [5.8692524852212325e-16],
 [7.131636879820554e-16],
 [6.574117928924077e-16],
 [6.082754862597981e-16],
 [6.5439567412322e-16],
 [1.2522450694008515e-15],
 [1.7273051068859717e-15],
 [2.868294987860344e-15],
 [9.476014391669887e-16],
 [4.480057513429942e-14],
 [8.078559841126996e-15],
 [3.0189082260438128e-15],
 [1.1187239841460449e-15],
 [6.103205353937467e-16],
 [6.556321091377225e-16],
 [5.564683190335995e-16],
 [4.674579058077468e-16],
 [4.484307624006696e-16],
 [7.532718172351559e-16],
 [9.068598691419567e-16],
 [1.1986163755489068e-15],
 [3.753377641401229e-16],
 [4.3066856803599585e-16],
 [6.884498392696892e-14],
 [9.461668976820907e-15],
 [2.2612485241579475e-15],
 [9.28091097097592e-16],
 [8.306252815485272e-16],
 [6.219768033933622e-16],
 [4.575568561800081e-16],
 [3.8395363563723005e-16],
 [5.690183763037016e-16],
 [6.139219901527024e-16],
 [6.933044910706134e-16],
 [5.034649377696982e-16],
 [1.2564385437216888e-13],
 [9.459955332721018e-15],
 [2.622148460924988e-15],
 [1.8669351561244668e-15],
 [1.2100280149451182e-15],
 [7.809898136429708e-16],
 [5.893561990371063e-16],
 [8.045068320401791e-16],
 [8.144068933345848e-16],
 [8.445892198641028e-16],
 [7.185758057691846e-16],
 [1.0487273595734782e-15],
 [4.910664240047019e-14],
 [6.125636602272762e-15],
 [2.982912957866799e-15],
 [1.544765749968978e-15],
 [8.316206513757888e-16],
 [5.538839362372618e-16],
 [6.957723625122194e-16],
 [6.641818614256484e-16],
 [6.491680397990966e-16],
 [4.514477405302967e-14],
 [7.486292168538665e-15],
 [2.6787743463778753e-15],
 [1.076636486004282e-15],
 [5.889969852628584e-16],
 [6.537374281460836e-16],
 [5.752324678352901e-16],
 [5.12148782868159e-16],
 [8.7353005710982e-16],
 [6.923848769762258e-14],
 [8.342406409369911e-15],
 [2.0821092513158255e-15],
 [8.46143419781043e-16],
 [7.71999221429648e-16],
 [5.970194871996074e-16],
 [4.693622041553687e-16],
 [1.3315110264942234e-13],
 [9.24081809423173e-15],
 [2.4668964382045307e-15],
 [1.7113380474709795e-15],
 [1.1007810490132471e-15],
 [7.302240792216235e-16],
 [4.8090685851376e-14],
 [6.101730178583315e-15],
 [2.9737904637661735e-15],
 [1.5422470361624926e-15],
 [8.441508769099643e-16],
 [4.814483443798141e-16],
 [4.519424832880532e-14],
 [7.503007843887973e-15],
 [2.7068089804691234e-15],
 [1.0882205752682291e-15],
 [5.499814865864916e-16],
 [6.08275486259798e-16],
 [6.881252053541531e-14],
 [8.390987755483306e-15],
 [2.022458537673152e-15],
 [5.893561990371064e-16],
 [1.272570127370646e-13],
 [9.20415690200729e-15],
 [1.1449130609377929e-15],
 [1.9676738781899634e-15],
 [4.908103086398338e-14],
 [8.144068933345852e-16],
 [5.752324678352903e-16],
 [1.1986163755489064e-15]]

    original_length = 992

    processed_arr = [None] * original_length

    for element, pos_list in positions.items():
        processed_element = processed_unique_arr[unique_arr.index(element)]
        for pos in pos_list:
            processed_arr[pos] = processed_element  # Map the processed element
    
    return processed_arr